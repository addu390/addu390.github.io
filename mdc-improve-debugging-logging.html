<!doctype html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Jekyll">
    <link rel="license" href="LICENSE">

    <meta name="application-name" content="PYBLOG">
    <meta name="theme-color" content="">
    <link rel="archives" href="https://pyblog.xyz/archives/">
    <link rel="me" href="https://mastodon.social/@addu390">

    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">

    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="stylesheet" href="/assets/code.css">
    <link rel="alternate" type="application/rss+xml" href="https://pyblog.xyz/feed.xml">
    <!-- TODO: Upgrade Google Analytics -->
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>MDC : Improving debugging/logging | PYBLOG</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="MDC : Improving debugging/logging" />
<meta name="author" content="Adesh Nalpet Adimurthy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Bob the builder, agrees!" />
<meta property="og:description" content="Bob the builder, agrees!" />
<link rel="canonical" href="https://pyblog.xyz/mdc-improve-debugging-logging" />
<meta property="og:url" content="https://pyblog.xyz/mdc-improve-debugging-logging" />
<meta property="og:site_name" content="PYBLOG" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MDC : Improving debugging/logging" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Adesh Nalpet Adimurthy" />
<script type="application/ld+json">
{"url":"https://pyblog.xyz/mdc-improve-debugging-logging","@type":"BlogPosting","description":"Bob the builder, agrees!","author":{"@type":"Person","name":"Adesh Nalpet Adimurthy"},"headline":"MDC : Improving debugging/logging","dateModified":"2021-12-27T00:00:00+00:00","datePublished":"2021-12-27T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://pyblog.xyz/mdc-improve-debugging-logging"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LWDR3LD16H"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-LWDR3LD16H');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/darkreader@4.9.44/darkreader.min.js"></script>
    <script src="/assets/main.js"></script>

    <!-- MailerLite Universal -->
    <script async>
        (function (w, d, e, u, f, l, n) {
            w[f] = w[f] || function () {
                (w[f].q = w[f].q || [])
                    .push(arguments);
            }, l = d.createElement(e), l.async = 1, l.src = u,
                n = d.getElementsByTagName(e)[0], n.parentNode.insertBefore(l, n);
        })
            (window, document, 'script', 'https://assets.mailerlite.com/js/universal.js', 'ml');
        ml('account', '1023335');
    </script>
    <!-- End MailerLite Universal -->
</head><body>

    <div id="layout" class="pure-g"><aside class="sidebar pure-u-1 pure-u-md-1-5">
    <div class="sidebar-info">
        <span hidden>PYBLOG</span>
        <img title="Start/Stop tear of joy!" id="profile-gif" class="brand-photo"
            src="https://pyblog.xyz/assets/img/profile/3.gif" alt="Photo of Adesh Nalpet Adimurthy" />
        <h1 class="brand-title">
            <a href="/">· PYBLOG ·</a>
        </h1>
        <br>
        <h2 class="brand-tagline">How do you know which watermelon <img id="showerButton" class="twemoji" src="https://pyblog.xyz/assets/img/emoji/watermelon.svg" alt=""> to pick?</h2>
        <p></p>
    </div>

    <ul class="sidebar-list">
        <li class="clickable-div high-featured" onclick="location.href='https://pyblog.xyz';"><span class="sidebar-index"><img
                    class="twemoji" src="https://pyblog.xyz/assets/img/emoji/home.svg" alt="home"></span>&nbsp; Home</li>
        <li class="clickable-div low-featured" onclick="location.href='https://pyblog.xyz/journals';"><span
                class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/book.svg"
                    alt="journal"></span>&nbsp;
            Journal</li>
        <li class="clickable-div high-featured" onclick="location.href='https://pyblog.xyz/subscribe';"><span
                class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/loveletter.svg"
                    alt="subscribe"></span>&nbsp; Subscribe</li>


        <li class="clickable-div low-featured" onclick="location.href='https://pyblog.xyz/contact';"><span
                class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/horn.svg"
                    alt="contact"></span>&nbsp;
            Contact</li>

        <li class="clickable-div low-featured" onclick="location.href='https://pyblog.xyz/about';"><span
                class="sidebar-index"><img style="vertical-align: top; width: 21px;" class="twemoji"
                    src="https://pyblog.xyz/assets/img/emoji/face.svg" alt="archive"></span>&nbsp;
            About</li>
        <li class="clickable-div low-featured"><a href="https://www.buymeacoffee.com/pyblog" target="_blank"><span
                    class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/luck.svg"
                        alt="sponsor"></span>&nbsp;
                Sponsor</a></li>
        <li class="clickable-div low-featured"><a href="https://medium.com/@pyblog/lists" target="_blank"><span
                    class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/medium.svg"
                        alt="medium"></span>&nbsp;
                Medium</a></li>
        <li class="clickable-div low-featured" onclick="location.href='https://pyblog.xyz/notes';"><span
                class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/notes.svg"
                    alt="notes"></span>&nbsp;
            Notes</li>
        <li class="clickable-div low-featured" onclick="location.href='https://pyblog.xyz/privacy';"><span
                class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/cookie.svg"
                    alt="privacy policy"></span>&nbsp;
            Privacy Policy</li>
        <li class="clickable-div low-featured" onclick="location.href='https://pyblog.xyz/categories';"><span
                class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/folder.svg"
                    alt="categories"></span>&nbsp;
            Categories</li>
        <li class="clickable-div low-featured" onclick="location.href='https://pyblog.xyz/archive';"><span
                class="sidebar-index"><img class="twemoji" src="https://pyblog.xyz/assets/img/emoji/archive.svg"
                    alt="archive"></span>&nbsp;
            Archive</li>
    </ul>
</aside>

<script src="/assets/sidebar.js"></script><div class="content pure-u-1 pure-u-md-4-5">
            <div id="showerContainer"></div>
            <div class="md-display"><div class="menu"><div id="search">
    <label>
        <svg class="icon svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" class="crayons-icon c-btn__icon" focusable="false"><path d="M18.031 16.617l4.283 4.282-1.415 1.415-4.282-4.283A8.96 8.96 0 0111 20c-4.968 0-9-4.032-9-9s4.032-9 9-9 9 4.032 9 9a8.96 8.96 0 01-1.969 5.617zm-2.006-.742A6.977 6.977 0 0018 11c0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7a6.977 6.977 0 004.875-1.975l.15-.15z"></path></svg>
        <input autocomplete="off" id="search-input" oninput="changeResultContainerDisp(this.value)" placeholder=" Search..." type="text"/>
        <span class="search-power-text">Powered by Simple Search</span>
    </label>
</div>
<ul id="results-container" style="display: none"></ul>
<script src="/assets/simple-jekyll-search.js"></script>
<script>
    function changeResultContainerDisp(val) {
        if (val) {
            document
                .getElementById("results-container")
                .style
                .display = "block";
            document.getElementById("search-input").addEventListener("blur", function () {
                document.addEventListener("click", function (event) {
                    var isClickInside = document.getElementById("results-container").contains(event.target);
                    if (! isClickInside) {
                        document
                            .getElementById("results-container")
                            .style
                            .display = "none";
                    }
                })
            })
        } else {
            document
                .getElementById("results-container")
                .style
                .display = "none";
        }
    }
    var sjs = SimpleJekyllSearch({
        searchInput: document.getElementById("search-input"),
        resultsContainer: document.getElementById("results-container"),
        json: "/search.json",
        searchResultTemplate: "<li class='search_res' style='list-style: none;'><a href='https://pyblog.xyz{url}' color: #555555;'><p><span class='dice-index'><img class='twemoji' src='../assets/img/emoji/{index}.svg'></span> &nbsp;{title}</p></a></li>",
        noResultsText: "No results found. Try another search.",
        fuzzy: false,
        limit: 5
    })
</script><a id="dark-mode-button">
        <img id="icon-light" class="twemoji theme-icon" src="https://pyblog.xyz/assets/img/emoji/light.svg" alt="">
        <img id="icon-dark" class="twemoji theme-icon" src="https://pyblog.xyz/assets/img/emoji/dark.svg" style="display: none;" alt="">
    </a>
    <a href="/feed.xml" target="_blank"><img class="svg-icon twemoji rss-icon" src="https://pyblog.xyz/assets/img/common/rss.svg"
            alt=""></a>
    <a id="sound-button">
        <img id="icon-sound-on" class="twemoji audio-icon svg-icon" src="https://pyblog.xyz/assets/img/common/audio-on.svg" style="display: none;" alt="">
        <img id="icon-sound-off" class="twemoji audio-icon svg-icon" src="https://pyblog.xyz/assets/img/common/audio-off.svg" alt="">
    </a>
</div>

<audio id="darkModeOn">
    <source src="https://pyblog.xyz/assets/sounds/switch-on.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<audio id="darkModeOff">
    <source src="https://pyblog.xyz/assets/sounds/switch-off.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<audio id="soundModeOn">
    <source src="https://pyblog.xyz/assets/sounds/enable-sound.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<audio id="soundModeOff">
    <source src="https://pyblog.xyz/assets/sounds/disable-sound.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio></div>
            <div>
                <div></div><div class="pure-g post-entry-toc" style="width: 100%; justify-content: center">
    <div class="posts pure-u-md-5-6">
        <article class="post-entry" itemscope itemtype="http://schema.org/BlogPosting">

            <header class="feed-header">
                <h2 class="post-title" itemprop="name headline">MDC : Improving debugging/logging</h2><p class="post-meta" data-id="/mdc-improve-debugging-logging" data-url="/mdc-improve-debugging-logging" data-title="MDC : Improving debugging/logging">
    <time datetime="2021-12-27T00:00:00+00:00" itemprop="datePublished">
        Dec 27, 2021
    </time><b class="post-meta-dots">·</b>
    <a href="https://pyblog.xyz/categories/java-lava">Java Lava</a><b class="post-meta-dots">·</b>
    <a href="https://pyblog.xyz/tags/dropwizard"> #Dropwizard</a>&#8239; 
    <a href="https://pyblog.xyz/tags/java"> #Java</a><span class="save-button float-right"><img class="twemoji svg-icon" src="https://pyblog.xyz/assets/img/common/bookmark-initial.svg" alt=""></span>
    <span class="float-right">3 min read</span>
</p></header>

            <div articlebody" class="post-body itemprop=">
                <p><img class="center-image" src="./assets/featured/bob-mdc.png" /></p>
<p style="text-align: center;">Bob the builder, agrees!</p>

<p>Construct your logs as good as Bob the Builder!</p>

<p>Usually in most of the backend applications, a separate thread from the thread pool processes a client request. Once the request is completed, the thread is returned to the thread pool and it’s typical logs are generated.</p>

<p>What are we trying to solve? Let’s take an example.</p>

<h2 id="example">Example:</h2>

<p>Consider a case where two users have logged in and are retrieving data from the database. It is easy to unravel which log statement belongs to which request by differentiating with thread ID. This thread-based correlation of logs is a useful technique to identify all the logs from a single request. However, with this technique, we could not differentiate which request belongs to which user. Now, things get even messier when multithreading is implemented.</p>

<h2 id="partial-solution">Partial solution:</h2>

<p>One of the approaches could be to generate a unique number when the request enters the service and print it with every log statement, but this would be once again difficult to co-relate to the user</p>

<h2 id="solution">Solution:</h2>

<p>Another solution would be to print the user ID and request ID for every log statement. request ID would be generated on the client side. request ID is unique for every request from the user. It will help in identifying a request in case there is a concurrent requests from multiple users (As we have the user ID as well). These are passed as an HTTP header with each request and appended to each log line.</p>

<h2 id="approach">Approach:</h2>

<p>The MDC provides a simple key/value (map) mechanism to capture small amounts of custom diagnostic data. Since it’s built into the logging framework, it’s really easy to add values from the MDC to each log line. MDC is supported by log4j, log4j2, and SL4J/logback (What is use in MF).</p>

<p>MDC allows us to fill a map-like structure with pieces of information that are accessible to the appender when the log message is actually written. The MDC structure is internally attached to the executing thread in the same way a ThreadLocal variable would be.</p>

<h2 id="the-high-level-idea-is">The high-level idea is:</h2>

<ul>
  <li>At the start of the thread, fill MDC with pieces of information that are required  to make available to the log appender</li>
  <li>Log the message</li>
</ul>

<h2 id="implementation">Implementation:</h2>

<p>My application stack : Java – Dropwizard
However, the idea behind this implementation holds good for any framework.</p>

<h3 id="a-method-interceptor-for-all-the-resource">A method interceptor for all the resource:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * @author adesh.nalpet
 * created on 20th December 2019
 * A resource method interceptor for adding request context to MDC (Logger)
 */
@Slf4j
public class RequestContextModule extends AbstractModule {

    @Override
    protected void configure() {
        final RequestContextInterceptor requestContextInterceptor = new RequestContextInterceptor();
        requestInjection(requestContextInterceptor);
        bindInterceptor(Matchers.any(), Matchers.annotatedWith(Path.class), requestContextInterceptor);
    }

    @VisibleForTesting
    public static class RequestContextInterceptor implements MethodInterceptor {

        @Override
        public Object invoke(MethodInvocation invocation) throws Throwable {

            /* Applicable for methods annotated with @Path (Resources) */
            final Optional&lt;Annotation&gt; optionalAnnotation = Stream.of(invocation.getMethod().getDeclaredAnnotations())
                    .filter(annotation -&gt; annotation instanceof Path)
                    .findFirst();

            if (optionalAnnotation.isPresent()) {
                final Annotation[][] parameterAnnotations = invocation.getMethod().getParameterAnnotations();

                for (int index = 0; index &lt; parameterAnnotations.length; ++index) {
                    for (final Annotation annotation : parameterAnnotations[index]) {
                        /* Check for method arguments annotated with @Auth */
                        if (annotation instanceof Auth) {
                            try {
                                final Auth auth = (Auth) invocation.getArguments()[index];
                                /* Add request and user ID to MDC
                                Note :
                                * Any information in Auth can be logged.
                                * Consider compliance restrictions before logging any sensitive information.
                                */
                                MDC.put(RequestContext.REQUEST_ID, auth.getRequestId());
                                MDC.put(RequestContext.REQUEST_USER_ID, auth.getUserId());
                            } catch (Exception e) {
                                /* Deliberately catching all exceptions,
                                to ensure application is not affected from logger
                                TODO : Set-up alerts for the below log */
                                log.error("[Auth to MDC] Error while fetching Auth");
                            }
                        }
                    }
                }
            }
            return invocation.proceed();
        }
    }
}
</code></pre></div></div>

<h3 id="response-filter-to-clear-context">Response filter to clear context:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * @author adesh.nalpet
 * created on 20th December 2019
 * A Servlet response filter to clear MDC.
 */
public class ClearContextResponseFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        /* deliberately nothing */
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        try {
            chain.doFilter(request, response);
        } finally {
            RequestContext.clearContext();
        }
    }

    @Override
    public void destroy() {
        /* deliberately nothing */
    }
}
</code></pre></div></div>

<h3 id="request-context">Request Context:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * @author adesh.nalpet
 * created on 20th December 2019
 * TODO : Validate storing RequestContext in thread local.
 */
public class RequestContext {

    public static final String REQUEST_ID = "request_id";
    public static final String REQUEST_USER_ID = "user_id";

    public static void clearContext() {
        MDC.remove(REQUEST_ID);
        MDC.remove(REQUEST_USER_ID);
    }
}
</code></pre></div></div>

<h2 id="logformat">LogFormat:</h2>

<p>logFormat: <code class="language-plaintext highlighter-rouge">"%(%-5level) [%date] %X{request_id} %X{user_id} [%thread] [%logger{0}]: %message%n"</code></p>


            </div>
            <img style="float: right; width: 5em;" src="../assets/img/common/puppy.gif" />
            <a class="u-url" href="/mdc-improve-debugging-logging" hidden></a>
        </article>
        <div class="blog-reference">
            <p>Cite this article as: Adesh Nalpet Adimurthy. (Dec 27, 2021). MDC : Improving debugging/logging.
                PyBlog. <a href="/mdc-improve-debugging-logging">https://www.pyblog.xyz/mdc-improve-debugging-logging</a>
            </p>
        </div>
        <div id="comments-section"></div>
        <div id="comments-script">
            <script src="https://utteranc.es/client.js" repo="addu390/addu390.github.io" issue-term="pathname"
            theme="github-light" crossorigin="anonymous" async>
        </script>
        </div>
        
    </div>
    <div class="posts-right-bar pure-u-md-1-6" style="display: flex; flex-direction: column;">
        <section class="post sidebar-scrollable-div sidebar-toc-div">
            <h3><img class="twemoji" src="../assets/img/emoji/snake.svg" alt=""> #index <span class="sub-header">table
                    of contents</span></h3>
            <div id="toc">
                <!-- Table of Contents will be injected here -->
            </div>
        </section>
    </div>
</div>
<script src="/assets/toc.js"></script>
            </div>
        </div>
    </div>
    <script src="/assets/reading-list.js"></script>
</body>

</html>